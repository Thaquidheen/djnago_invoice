{% extends "layout.html" %}

{% block title %}
Invoice Generating
{% endblock %}





{% block content %}
{% load static %}
<div class="container">
    <h2>Generate Invoice</h2>

    <form method="post">
        {% csrf_token %}
        <table>

            <div class="form-row">
                <div class="form-group col-md-4 mb-4">
                    <label for="customer">Customer Name:</label>
                    <select name="customer" id="customer" class="form-control">
                        {% for customer in customers %}
                        <option value="{{ customer.customer_name }}">{{ customer.customer_name }}</option>
                        {% endfor %}
                     
                    </select>
                </div>
                <div class="form-group col-md-4 mb-4">
                    <label for="invoice-date">Invoice Date:</label>
                    <input type="date" name="invoice-date" id="invoice-date" class="form-control">
                </div>
                <div class="form-group col-md-4 mb-4">
                    <label for="invoice-number">Invoice Number:</label>
                    <input type="text" name="invoice-number" id="invoice-number" class="form-control">
                </div>
            </div>
            <tbody id="items-container">
        <tr class="item-row">
         

    
            <td>
                <label for="item">Item:</label>
           
                <select name="item" id="item" class="form-control">
                   
                </select>
            </td>
            <td>
                <label for="thickness">Thickness:</label>
           
            
                </select> 
                <select name="thickness" id="thickness" class="form-control">
     
                </select>
            </td>
            <td>
                <label for="size">Size:</label>
                <select name="size" id="size" class="form-control">
           
                </select>
            </td>
            <td>
                <label for="quantity">Quantity:</label>
                <input type="number" name="quantity" id="quantity" class="form-control">
       
            </td>
       
            <td>
                <label for="area">Area:</label>
                <input type="number" name="area" id="area" class="form-control">
      
            </td>
            <td>
                <label for="rate">Rate:</label>
                <select name="rate" id="rate" class="form-control" readonly>
       
                </select>
            </td>
            <td>
                <label for="amount">Amount:</label>
                <input type="text" id="amount" name="amount" class="form-control">
            </td>
          
        </tr>
  
    </tbody>
    </table>
    </form>

    <div class="mt-5" style="text-align: right;">
       
 
    </div>
 
    <div class="mt-5 " style="text-align: right;">
        <button class="bg-success p-2 bg-variant">invoice</button>
    </div>
</div>


<script>
    $(document).ready(function() {
  



    function populateItems() {
        $.ajax({
            url: '/invoice/get_items/',
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                var itemSelect = $('#item');
                itemSelect.empty();
                var defaultOption = $('<option value="">Select an item</option>').attr('selected', 'selected');
                itemSelect.append(defaultOption);
                $.each(data.items, function(index, item) {
                    var option = $('<option value="' + item.id + '">' + item.item_name + ' </option>');
                    option.data('variations', item.variations); 
                    itemSelect.append(option);
                });
            },
            error: function(xhr, status, error) {
                console.log(error);
            }
        });
    }


    populateItems();


    $('#item').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var variations = selectedOption.data('variations');
        

        var thicknessSelect = $('#thickness');
        var sizeSelect = $('#size');
        var rateSelect = $('#rate');
        
        thicknessSelect.empty();
        sizeSelect.empty();
        rateSelect.empty();
        
        $.each(variations, function(index, variation) {
            thicknessSelect.append('<option value="' + variation.thickness + '">' + variation.thickness + '</option>');
            sizeSelect.append('<option value="' + variation.size + '">' + variation.size + '</option>');
            rateSelect.append('<option value="' + variation.rate + '">' + variation.rate + '</option>');
        });
        
 
        updateFields();
    });



    function parseFraction(input) {

    const parts = input.split('/');
    if (parts.length === 2) {
        const numerator = parseFloat(parts[0]);
        const denominator = parseFloat(parts[1]);
        
        if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
    
            return {
                numerator: numerator,
                denominator: denominator
            };
        }
    }

    return null;
}


    function updateFields() {
        var quantity = parseFloat($('#quantity').val());
        var size = $('#size').val();
        var rate = parseFloat($('#rate').val());
        console.log('Quantity:', quantity);
        console.log('Size:', size);
        console.log('Rate:', rate);

        var sizeFraction = parseFraction(size);
        console.log(sizeFraction)
        var area = (quantity * sizeFraction.numerator) / sizeFraction.denominator;
        console.log(area)
        var amount = area * rate;
        console.log(amount)
        var formattedArea = area.toFixed(2);
        $('#area').val(formattedArea);
        $('#amount').val(amount.toFixed(2)); 
    }




$('#quantity, #size, #rate').on('input', updateFields);

   

});

</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

{% endblock %}